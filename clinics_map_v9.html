<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>detrans • Clinics Map</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root { color-scheme: light; }
    #map { height: 100%; width: 100%; }

    .leaflet-control-zoom a {
      border-radius: 10px !important;
      border: 1px solid rgba(0,0,0,0.08) !important;
      box-shadow: 0 10px 25px rgba(0,0,0,0.08) !important;
    }
    .leaflet-popup-content-wrapper {
      border-radius: 16px !important;
      box-shadow: 0 16px 40px rgba(0,0,0,0.18) !important;
    }
    .leaflet-popup-tip {
      box-shadow: 0 16px 40px rgba(0,0,0,0.12) !important;
    }

    .marker-dot {
      width: 18px;
      height: 18px;
      border-radius: 9999px;
      border: 3px solid white;
      box-shadow: 0 10px 24px rgba(0,0,0,0.28);
    }
    .marker-dot[data-kind="surg"] { background: #dc2626; }
    .marker-dot[data-kind="hrt"]  { background: #f59e0b; }
    .marker-dot[data-kind="both"] {
      background: #b91c1c;
      box-shadow: 0 0 0 4px rgba(220,38,38,0.22), 0 12px 26px rgba(0,0,0,0.30);
    }

    @keyframes shimmer { 0% { transform: translateX(-60%); } 100% { transform: translateX(60%); } }
    .skeleton { position: relative; overflow: hidden; background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 16px; }
    .skeleton::after {
      content: ""; position: absolute; inset: 0; width: 120%;
      background: linear-gradient(90deg, rgba(241,245,249,0) 0%, rgba(226,232,240,0.9) 45%, rgba(241,245,249,0) 100%);
      animation: shimmer 1.1s ease-in-out infinite;
      transform: translateX(-60%);
    }

    .clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .list-pad { padding-right: 14px; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 h-screen overflow-hidden">
  <header class="h-14 bg-white/90 backdrop-blur border-b border-slate-200 px-4 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-8 h-8 rounded-xl bg-slate-900 text-white flex items-center justify-center font-semibold tracking-tight">d</div>
      <div class="leading-tight">
        <div class="text-sm font-semibold tracking-tight">
          <span class="text-slate-900">de</span><span class="text-red-600">trans</span>
        </div>
        <div class="text-[11px] text-slate-500 -mt-0.5">Clinic map</div>
      </div>
    </div>

    <div class="flex items-center gap-2 text-xs text-slate-500">
      <span class="hidden sm:inline">Urgency:</span>
      <span class="inline-flex items-center gap-1 rounded-full border border-red-200 bg-red-50 px-2 py-1 text-red-800">
        <span class="w-2 h-2 rounded-full bg-red-600 inline-block"></span> Surgery
      </span>
      <span class="inline-flex items-center gap-1 rounded-full border border-amber-200 bg-amber-50 px-2 py-1 text-amber-800">
        <span class="w-2 h-2 rounded-full bg-amber-500 inline-block"></span> HRT
      </span>
    </div>
  </header>

  <div class="h-[calc(100vh-56px)] flex">
    <aside class="w-[380px] max-w-[90vw] bg-white/90 backdrop-blur border-r border-slate-200 flex flex-col">
      <div class="px-5 pt-5 pb-4 border-b border-slate-200">
        <div class="flex items-start justify-between gap-3">
          <div>
            <h1 class="text-xl font-semibold tracking-tight">Clinics</h1>
            <p class="text-sm text-slate-600 mt-1">
              <span class="font-medium text-red-700">Surgery</span> is urgent. <span class="font-medium text-amber-700">HRT</span> is medium.
            </p>
          </div>
          <button id="fitBtn" class="shrink-0 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm hover:bg-slate-50 transition">
            Fit map
          </button>
        </div>

        <div class="mt-4 flex gap-2">
          <label class="flex-1 flex items-center justify-between gap-3 rounded-2xl border border-slate-200 bg-white px-4 py-3">
            <div class="flex items-center gap-2">
              <span class="inline-block w-2.5 h-2.5 rounded-full bg-amber-500"></span>
              <span class="text-sm font-medium">HRT</span>
            </div>
            <input id="filterHrt" type="checkbox" class="h-4 w-4 accent-amber-500" checked />
          </label>

          <label class="flex-1 flex items-center justify-between gap-3 rounded-2xl border border-slate-200 bg-white px-4 py-3">
            <div class="flex items-center gap-2">
              <span class="inline-block w-2.5 h-2.5 rounded-full bg-red-600"></span>
              <span class="text-sm font-medium">Surgery</span>
            </div>
            <input id="filterSurgery" type="checkbox" class="h-4 w-4 accent-red-600" checked />
          </label>
        </div>

        <div class="mt-3">
          <input id="searchBox" type="text" placeholder="Search by name, borough, or address…"
            class="w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm outline-none focus:border-slate-400" />
        </div>

        <div class="mt-3 flex items-center justify-between text-xs text-slate-500">
          <div>
            <span id="statShown" class="font-semibold text-slate-700">0</span> shown
            <span class="mx-1">•</span>
            <span id="statLoaded">0</span> total
          </div>
          <button id="refreshBtn" class="hover:text-slate-700 transition">Refresh</button>
        </div>
      </div>

      <div class="flex-1 overflow-auto px-3 py-3 list-pad">
        <div id="skeletonWrap" class="space-y-2">
          <div class="skeleton p-4"><div class="h-3 w-2/3 rounded bg-slate-200"></div><div class="mt-3 h-2 w-5/6 rounded bg-slate-200"></div><div class="mt-2 h-2 w-4/6 rounded bg-slate-200"></div></div>
          <div class="skeleton p-4"><div class="h-3 w-3/5 rounded bg-slate-200"></div><div class="mt-3 h-2 w-11/12 rounded bg-slate-200"></div><div class="mt-2 h-2 w-3/6 rounded bg-slate-200"></div></div>
          <div class="skeleton p-4"><div class="h-3 w-1/2 rounded bg-slate-200"></div><div class="mt-3 h-2 w-10/12 rounded bg-slate-200"></div><div class="mt-2 h-2 w-4/6 rounded bg-slate-200"></div></div>
          <div class="skeleton p-4"><div class="h-3 w-2/4 rounded bg-slate-200"></div><div class="mt-3 h-2 w-11/12 rounded bg-slate-200"></div><div class="mt-2 h-2 w-5/6 rounded bg-slate-200"></div></div>
          <div class="skeleton p-4"><div class="h-3 w-3/4 rounded bg-slate-200"></div><div class="mt-3 h-2 w-9/12 rounded bg-slate-200"></div><div class="mt-2 h-2 w-6/12 rounded bg-slate-200"></div></div>
        </div>

        <div id="list" class="space-y-2 hidden"></div>

        <div id="debug" class="hidden mt-3 text-[11px] text-slate-500"></div>
      </div>

      <div class="px-5 py-4 border-t border-slate-200 text-xs text-slate-500">
        Matching rule: values that start with “Yes” count as Yes (e.g., “Yes/Unlisted”, “Yes (varies by site)”). Coords parsed even if annotated.
      </div>
    </aside>

    <main class="flex-1">
      <div id="map" class="h-full"></div>
    </main>
  </div>

  <script>
    const DATA_URL = "https://sheet2api.com/v1/Y6ffm9keQbKC/clinics";
    const DEFAULT_CENTER = [40.7128, -74.0060];
    const DEFAULT_ZOOM = 11;

    const $ = (id) => document.getElementById(id);
    const safeStr = (v) => (v == null ? "" : String(v)).trim();

    function isYes(v) {
      const s = safeStr(v);
      return /^yes\\b/i.test(s);
    }

    let keyMap = null;
    function normKey(k) {
      return String(k || "")
        .toLowerCase()
        .replace(/[“”]/g, '"')
        .replace(/[’]/g, "'")
        .replace(/\\s+/g, " ")
        .trim();
    }
    function buildKeyMap(row) {
      const m = new Map();
      for (const k of Object.keys(row || {})) m.set(normKey(k), k);
      return m;
    }
    function getVal(row, wanted) {
      if (!row) return "";
      if (row[wanted] != null) return row[wanted];
      if (!keyMap) keyMap = buildKeyMap(row);
      const actual = keyMap.get(normKey(wanted));
      return actual ? row[actual] : "";
    }

    function normalizeAddress(addr) {
      let s = safeStr(addr);
      while (true) {
        const before = s;
        s = s.replace(/\\s*\\([^)]*\\)\\s*$/g, "").trim();
        s = s.replace(/\\s*\\[[^\\]]*\\]\\s*$/g, "").trim();
        if (s === before) break;
      }
      return s.replace(/\\s+/g, " ").trim();
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function parseCoord(v) {
      if (v == null) return null;
      if (typeof v === "number") return Number.isFinite(v) ? v : null;
      const s = safeStr(v);
      if (!s) return null;
      const m = s.match(/-?\\d+(\\.\\d+)?/);
      if (!m) return null;
      const n = Number(m[0]);
      return Number.isFinite(n) ? n : null;
    }

    function kindOf(row) {
      const h = isYes(getVal(row, "Offers hormones (HRT)"));
      const s = isYes(getVal(row, "Offers surgery"));
      if (h && s) return "both";
      if (s) return "surg";
      if (h) return "hrt";
      return null;
    }

    const map = L.map("map", { zoomControl: true }).setView(DEFAULT_CENTER, DEFAULT_ZOOM);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const markersLayer = L.layerGroup().addTo(map);
    const markerById = new Map();

    function popupHtml(row) {
      const name = safeStr(getVal(row, "Provider / Program")) || "(Unnamed)";
      const borough = safeStr(getVal(row, "Borough"));
      const addr = normalizeAddress(getVal(row, "Address"));

      const hrt = isYes(getVal(row, "Offers hormones (HRT)")) ? "Yes" : "No";
      const surg = isYes(getVal(row, "Offers surgery")) ? "Yes" : "No";
      const hrtMinors = isYes(getVal(row, "HRT to minors?")) ? "Yes" : "No";
      const surgMinors = isYes(getVal(row, "Surgery to minors?")) ? "Yes" : "No";

      const k = kindOf(row);
      const badge =
        k === "both" ? `<span style="display:inline-block;padding:2px 8px;border-radius:9999px;background:#fee2e2;color:#991b1b;border:1px solid #fecaca;font-size:11px;font-weight:700">High urgency</span>` :
        k === "surg" ? `<span style="display:inline-block;padding:2px 8px;border-radius:9999px;background:#fee2e2;color:#991b1b;border:1px solid #fecaca;font-size:11px;font-weight:700">Urgent (Surgery)</span>` :
        `<span style="display:inline-block;padding:2px 8px;border-radius:9999px;background:#fffbeb;color:#92400e;border:1px solid #fde68a;font-size:11px;font-weight:700">HRT</span>`;

      return `
        <div style="min-width:240px">
          <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:6px">
            <div style="font-weight:800;line-height:1.2">${escapeHtml(name)}</div>
            ${badge}
          </div>
          <div style="font-size:12px;opacity:.78;margin-bottom:10px">
            ${escapeHtml(borough ? borough + " • " : "")}${escapeHtml(addr)}
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px">
            <div><b>HRT:</b> ${hrt}</div>
            <div><b>Surgery:</b> ${surg}</div>
            <div><b>HRT to minors:</b> ${hrtMinors}</div>
            <div><b>Surgery to minors:</b> ${surgMinors}</div>
          </div>
        </div>
      `;
    }

    function passesFilters(row) {
      const showH = $("filterHrt").checked;
      const showS = $("filterSurgery").checked;
      const k = kindOf(row);
      if (!k) return false;
      if ((k === "hrt" || k === "both") && showH) return true;
      if ((k === "surg" || k === "both") && showS) return true;
      return false;
    }

    function matchesSearch(row, q) {
      if (!q) return true;
      const name = safeStr(getVal(row, "Provider / Program")).toLowerCase();
      const borough = safeStr(getVal(row, "Borough")).toLowerCase();
      const addr = normalizeAddress(getVal(row, "Address")).toLowerCase();
      return name.includes(q) || borough.includes(q) || addr.includes(q);
    }

    function rowId(row, idx) {
      const name = safeStr(getVal(row, "Provider / Program"));
      const addr = normalizeAddress(getVal(row, "Address"));
      return (name + "|" + addr + "|" + idx).toLowerCase();
    }

    function clearMarkers() {
      markersLayer.clearLayers();
      markerById.clear();
    }

    function makeDivIcon(kind) {
      const html = `<div class="marker-dot" data-kind="${kind}"></div>`;
      return L.divIcon({ className: "marker-wrap", html, iconSize: [18,18], iconAnchor: [9,9], popupAnchor: [0,-10] });
    }

    function setLoading(isLoading) {
      const sk = $("skeletonWrap");
      const list = $("list");
      if (isLoading) { sk.classList.remove("hidden"); list.classList.add("hidden"); }
      else { sk.classList.add("hidden"); list.classList.remove("hidden"); }
    }

    let rows = [];

    function render() {
      const q = safeStr($("searchBox").value).toLowerCase();
      clearMarkers();

      const listEl = $("list");
      listEl.innerHTML = "";

      let shown = 0;
      let haveKind = 0;
      let haveCoords = 0;

      const sorted = [...rows].sort((a, b) => {
        const order = { both: 3, surg: 2, hrt: 1, "": 0 };
        const ak = kindOf(a) || "";
        const bk = kindOf(b) || "";
        if (order[bk] !== order[ak]) return order[bk] - order[ak];
        return safeStr(getVal(a, "Provider / Program")).localeCompare(safeStr(getVal(b, "Provider / Program")));
      });

      for (let i = 0; i < sorted.length; i++) {
        const row = sorted[i];
        const k = kindOf(row);
        if (k) haveKind++;
        if (!passesFilters(row)) continue;
        if (!matchesSearch(row, q)) continue;

        const lat = parseCoord(getVal(row, "Latitude"));
        const lon = parseCoord(getVal(row, "Longitude"));
        if (lat == null || lon == null) continue;
        haveCoords++;

        const id = rowId(row, i);

        const m = L.marker([lat, lon], { icon: makeDivIcon(k) })
          .bindPopup(popupHtml(row), { maxWidth: 380 });
        m.addTo(markersLayer);
        markerById.set(id, m);
        shown++;

        const name = safeStr(getVal(row, "Provider / Program")) || "(Unnamed)";
        const borough = safeStr(getVal(row, "Borough"));
        const addr = normalizeAddress(getVal(row, "Address"));

        const pills = `
          ${(k === "hrt" || k === "both") ? `<span class="text-[11px] px-2 py-0.5 rounded-full bg-amber-50 text-amber-800 border border-amber-100 font-semibold whitespace-nowrap">HRT</span>` : ""}
          ${(k === "surg" || k === "both") ? `<span class="text-[11px] px-2 py-0.5 rounded-full bg-red-50 text-red-800 border border-red-100 font-semibold whitespace-nowrap">Surgery</span>` : ""}
          ${(k === "both") ? `<span class="text-[11px] px-2 py-0.5 rounded-full bg-red-100 text-red-900 border border-red-200 font-bold whitespace-nowrap">High urgency</span>` : ""}
        `;

        const leftAccent = (k === "both") ? "bg-red-700" : (k === "surg") ? "bg-red-600" : "bg-amber-500";

        const item = document.createElement("button");
        item.className = "w-full text-left rounded-2xl border border-slate-200 bg-white hover:bg-slate-50 transition";
        item.innerHTML = `
          <div class="flex">
            <div class="w-1.5 ${leftAccent} rounded-l-2xl"></div>
            <div class="flex-1 px-4 py-3 min-w-0">
              <div class="flex items-start justify-between gap-3">
                <div class="min-w-0 pr-1">
                  <div class="font-semibold text-sm leading-snug clamp-2 break-words">${escapeHtml(name)}</div>
                  <div class="mt-1 text-xs text-slate-600 clamp-2 break-words">
                    ${escapeHtml(borough ? borough + " • " : "")}${escapeHtml(addr)}
                  </div>
                </div>
                <div class="shrink-0 flex flex-wrap gap-1 justify-end max-w-[44%]">${pills}</div>
              </div>
            </div>
          </div>
        `;

        item.addEventListener("click", () => {
          const mm = markerById.get(id);
          if (mm) { map.setView(mm.getLatLng(), 15); mm.openPopup(); }
        });

        listEl.appendChild(item);
      }

      $("statShown").textContent = shown;
      $("statLoaded").textContent = rows.length;
      $("debug").textContent = `debug: haveKind=${haveKind}/${rows.length} • haveCoords=${haveCoords}/${rows.length} • shown=${shown}`;
    }

    function fitToMarkers() {
      const layers = markersLayer.getLayers();
      if (!layers.length) { map.setView(DEFAULT_CENTER, DEFAULT_ZOOM); return; }
      const group = L.featureGroup(layers);
      map.fitBounds(group.getBounds().pad(0.15));
    }

    async function fetchData() {
      const res = await fetch(DATA_URL, { cache: "no-store" });
      if (!res.ok) throw new Error(`Data fetch failed: ${res.status}`);
      const data = await res.json();
      if (!Array.isArray(data)) throw new Error("Unexpected response: expected an array.");
      rows = data;
      keyMap = rows.length ? buildKeyMap(rows[0]) : null;
    }

    async function loadAll() {
      try {
        setLoading(true);
        await fetchData();
        render();
        fitToMarkers();
      } catch (e) {
        console.error(e);
      } finally {
        setLoading(false);
      }
    }

    $("filterHrt").addEventListener("change", () => { render(); fitToMarkers(); });
    $("filterSurgery").addEventListener("change", () => { render(); fitToMarkers(); });
    $("searchBox").addEventListener("input", () => { clearTimeout(window.__qTimer); window.__qTimer = setTimeout(render, 120); });
    $("refreshBtn").addEventListener("click", loadAll);
    $("fitBtn").addEventListener("click", fitToMarkers);

    loadAll();
  </script>
</body>
</html>
